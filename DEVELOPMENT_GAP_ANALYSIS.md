# Search MCP Server - 開発ギャップ分析

**作成日**: 2025-11-06
**対象**: ドキュメントに基づく計画機能と実装状況の比較

## エグゼクティブサマリー

Search MCP Serverは**Phase 1（MCPアグリゲーター）**の基本機能が実装されていますが、設計ドキュメントで計画されている多くの機能がまだ未実装です。特に、検索機能、セキュリティ機能、ツール管理機能、拡張機能が未実装です。

**実装進捗率**: 約25%（Phase 1の基本部分のみ）

---

## 📊 フェーズ別実装状況

### Phase 1: MCPアグリゲーター基本機能 【約75%完了】

#### ✅ 実装済み

| 機能 | 実装ファイル | 備考 |
|------|------------|------|
| 設定ファイル読み込み（JSON） | `src/mcp/mcp-client-manager.ts:loadConfig()` | ✓ 完全実装 |
| MCPサーバーとのstdio通信 | `src/mcp/mcp-client.ts` | ✓ 完全実装 |
| MCPサーバー起動・停止 | `src/mcp/mcp-client.ts:start(),stop()` | ✓ 完全実装 |
| 複数MCPからのツール集約 | `src/mcp/mcp-client-manager.ts:aggregateTools()` | ✓ 完全実装 |
| 軽量なツール一覧API | `src/mcp/mcp-client-manager.ts:listAllTools()` | ✓ コンテキスト削減実装済み |
| ツール実行のプロキシ | `src/mcp/mcp-client-manager.ts:executeTool()` | ✓ 完全実装 |
| 基本的なツールレジストリ | `src/tool-registry.ts` | ✓ 基本実装済み |

#### ❌ 未実装（Phase 1）

| 機能 | ドキュメント参照 | 重要度 |
|------|---------------|-------|
| MCPサーバー自動再接続 | `docs/design/08-mcp-aggregator.md` | 🔴 **高** |
| 既存設定からの移行ツール（migrate） | `docs/design/07-simplified-setup.md` | 🟡 **中** |
| 基本的なCLI（start/stop/status） | `docs/design/07-simplified-setup.md` | 🟡 **中** |
| エラークラス階層 | `docs/design/01-core-features.md:467-537` | 🔴 **高** |
| 構造化ログシステム（Pino） | `docs/design/05-performance-monitoring.md:474-573` | 🟢 **低** |
| 設定管理システム | `docs/design/01-core-features.md:671-709` | 🟡 **中** |
| ツールパラメータバリデーション | `docs/design/01-core-features.md:147-162` | 🔴 **高** |

---

### Phase 2: 検索機能強化 【0%完了】

#### ❌ 完全未実装

| 機能 | ドキュメント参照 | 重要度 | 推定工数 |
|------|---------------|-------|----------|
| テキスト検索（部分一致/前方一致/完全一致） | `docs/design/02-search-features.md:19-166` | 🔴 **高** | 3-5日 |
| タグベースの検索・フィルタリング | `docs/design/02-search-features.md:219-368` | 🟡 **中** | 2-3日 |
| カテゴリフィルタリング | `docs/design/02-search-features.md:370-452` | 🟡 **中** | 1-2日 |
| 複合検索API | `docs/design/02-search-features.md:454-636` | 🔴 **高** | 3-4日 |
| 検索結果のソート・ページネーション | `docs/design/02-search-features.md:454-636` | 🟡 **中** | 1-2日 |
| 検索インデックス構築 | `docs/design/02-search-features.md:781-862` | 🟢 **低** | 2-3日 |

**Phase 2 合計推定工数**: 12-19日

---

### Phase 3: セキュリティとパフォーマンス 【0%完了】

#### ❌ 完全未実装

| 機能 | ドキュメント参照 | 重要度 | 推定工数 |
|------|---------------|-------|----------|
| **セキュリティ機能** |
| APIキー認証 | `docs/design/03-security-features.md:22-175` | 🔴 **高** | 3-4日 |
| 権限ベースのアクセス制御（RBAC） | `docs/design/03-security-features.md:177-214` | 🟡 **中** | 2-3日 |
| レート制限 | `docs/design/03-security-features.md:240-383` | 🔴 **高** | 2-3日 |
| 入力バリデーション（JSONスキーマ） | `docs/design/03-security-features.md:386-570` | 🔴 **高** | 2-3日 |
| サンドボックス実行（VM2） | `docs/design/03-security-features.md:572-638` | 🟡 **中** | 3-5日 |
| セキュリティヘッダー設定 | `docs/design/03-security-features.md:724-773` | 🟢 **低** | 1日 |
| 監査ログ | `docs/design/03-security-features.md:775-861` | 🟡 **中** | 2-3日 |
| **パフォーマンス機能** |
| メモリキャッシュ（LRU/LFU） | `docs/design/05-performance-monitoring.md:15-267` | 🔴 **高** | 3-4日 |
| 並列実行エンジン | `docs/design/05-performance-monitoring.md:307-470` | 🟡 **中** | 2-3日 |
| Prometheusメトリクス収集 | `docs/design/05-performance-monitoring.md:627-800` | 🟢 **低** | 2-3日 |
| ヘルスチェックAPI | `docs/design/05-performance-monitoring.md:802-946` | 🟡 **中** | 1-2日 |

**Phase 3 合計推定工数**: 23-34日

---

### Phase 4: ツール管理の高度化 【0%完了】

#### ❌ 完全未実装

| 機能 | ドキュメント参照 | 重要度 | 推定工数 |
|------|---------------|-------|----------|
| ツールの動的登録API | `docs/design/04-tool-management.md:14-229` | 🟡 **中** | 3-4日 |
| バージョン管理システム | `docs/design/04-tool-management.md:231-441` | 🟢 **低** | 3-4日 |
| 依存関係管理 | `docs/design/04-tool-management.md:443-587` | 🟢 **低** | 2-3日 |
| ライフサイクル管理 | `docs/design/04-tool-management.md:589-703` | 🟢 **低** | 2-3日 |
| ツール設定管理 | `docs/design/04-tool-management.md:705-798` | 🟡 **中** | 2-3日 |
| ホットリロード機能 | `docs/design/04-tool-management.md:800-868` | 🟢 **低** | 2-3日 |

**Phase 4 合計推定工数**: 14-20日

---

### Phase 5: 拡張機能 【0%完了】

#### ❌ 完全未実装

| 機能 | ドキュメント参照 | 重要度 | 推定工数 |
|------|---------------|-------|----------|
| プラグインシステム | `docs/design/06-extension-features.md:14-210` | 🟢 **低** | 4-5日 |
| ツールの合成機能 | `docs/design/06-extension-features.md:212-345` | 🟢 **低** | 3-4日 |
| Docker実行エンジン | `docs/design/06-extension-features.md:347-580` | 🟢 **低** | 5-7日 |
| ワークフローエンジン | `docs/design/06-extension-features.md:582-846` | 🟢 **低** | 5-7日 |
| イベントシステム | `docs/design/06-extension-features.md:848-903` | 🟢 **低** | 2-3日 |
| WebHook統合 | `docs/design/06-extension-features.md:905-995` | 🟢 **低** | 2-3日 |
| セマンティック検索（ベクトル） | `docs/design/02-search-features.md:638-776` | 🟢 **低** | 5-7日 |

**Phase 5 合計推定工数**: 26-36日

---

## 🎯 優先度別実装推奨順序

### 🔴 最優先（High Priority）- コア機能の完成

これらはシステムの安定性と基本的な運用に不可欠です。

| # | 機能 | 理由 | 工数 | Phase |
|---|------|------|------|-------|
| 1 | **エラークラス階層** | 適切なエラーハンドリングは安定性の基礎 | 1-2日 | Phase 1 |
| 2 | **ツールパラメータバリデーション** | 実行時エラーを防ぐために必須 | 2-3日 | Phase 1 |
| 3 | **MCPサーバー自動再接続** | 長時間実行時の安定性に必須 | 3-4日 | Phase 1 |
| 4 | **テキスト検索** | プロジェクトの主要機能（Search MCP） | 3-5日 | Phase 2 |
| 5 | **複合検索API** | ツール発見の中核機能 | 3-4日 | Phase 2 |
| 6 | **APIキー認証** | 本番環境での使用に必須 | 3-4日 | Phase 3 |
| 7 | **レート制限** | DoS攻撃対策に必須 | 2-3日 | Phase 3 |
| 8 | **入力バリデーション** | セキュリティの基本 | 2-3日 | Phase 3 |
| 9 | **メモリキャッシュ** | パフォーマンス向上に重要 | 3-4日 | Phase 3 |

**最優先タスク合計工数**: 22-32日

---

### 🟡 中優先（Medium Priority）- 運用性向上

これらは運用を容易にし、ユーザーエクスペリエンスを向上させます。

| # | 機能 | 理由 | 工数 | Phase |
|---|------|------|------|-------|
| 10 | **CLIコマンド（start/stop/status）** | 運用性向上 | 2-3日 | Phase 1 |
| 11 | **設定管理システム** | ツール別設定が必要 | 2-3日 | Phase 1 |
| 12 | **既存設定からの移行ツール** | ユーザーのオンボーディング | 1-2日 | Phase 1 |
| 13 | **タグベースの検索** | 検索機能の充実 | 2-3日 | Phase 2 |
| 14 | **カテゴリフィルタリング** | ツール整理に有用 | 1-2日 | Phase 2 |
| 15 | **検索結果のソート・ページネーション** | UX向上 | 1-2日 | Phase 2 |
| 16 | **権限ベースのアクセス制御** | 複数ユーザー環境で有用 | 2-3日 | Phase 3 |
| 17 | **サンドボックス実行** | セキュリティ強化 | 3-5日 | Phase 3 |
| 18 | **監査ログ** | トラブルシューティングに有用 | 2-3日 | Phase 3 |
| 19 | **並列実行エンジン** | パフォーマンス向上 | 2-3日 | Phase 3 |
| 20 | **ヘルスチェックAPI** | 運用監視に有用 | 1-2日 | Phase 3 |
| 21 | **ツールの動的登録API** | 拡張性向上 | 3-4日 | Phase 4 |
| 22 | **ツール設定管理** | 柔軟な設定 | 2-3日 | Phase 4 |

**中優先タスク合計工数**: 24-37日

---

### 🟢 低優先（Low Priority）- 高度な機能

これらはnice-to-haveな機能です。基本機能が完成してから実装を検討します。

| # | 機能 | 理由 | 工数 | Phase |
|---|------|------|------|-------|
| 23 | 構造化ログシステム | 開発・デバッグに有用 | 1-2日 | Phase 1 |
| 24 | 検索インデックス構築 | 大規模ツール数での最適化 | 2-3日 | Phase 2 |
| 25 | セキュリティヘッダー設定 | セキュリティ強化 | 1日 | Phase 3 |
| 26 | Prometheusメトリクス収集 | 詳細な監視 | 2-3日 | Phase 3 |
| 27 | バージョン管理システム | 高度なツール管理 | 3-4日 | Phase 4 |
| 28 | 依存関係管理 | 複雑なツール関係の管理 | 2-3日 | Phase 4 |
| 29 | ライフサイクル管理 | 高度なツール制御 | 2-3日 | Phase 4 |
| 30 | ホットリロード機能 | 開発体験向上 | 2-3日 | Phase 4 |
| 31-37 | Phase 5のすべての機能 | 拡張性を提供するが基本機能ではない | 26-36日 | Phase 5 |

**低優先タスク合計工数**: 41-57日

---

## 📈 推奨実装ロードマップ

### スプリント1（2-3週間）: コアの安定化

**目標**: Phase 1を完成させ、安定したMCPアグリゲーターを提供

- [x] MCPアグリゲーター基本機能（既存）
- [ ] エラークラス階層
- [ ] ツールパラメータバリデーション
- [ ] MCPサーバー自動再接続
- [ ] CLIコマンド
- [ ] 設定管理システム
- [ ] 既存設定からの移行ツール

**期待される成果**: 安定したPhase 1の完全版

---

### スプリント2（2-3週間）: 検索機能の実装

**目標**: プロジェクトの主要価値提案である検索機能を実装

- [ ] テキスト検索（部分一致/前方一致/完全一致）
- [ ] 複合検索API
- [ ] タグベースの検索
- [ ] カテゴリフィルタリング
- [ ] 検索結果のソート・ページネーション

**期待される成果**: Phase 2の基本機能完成、"Search MCP"の名に相応しい機能

---

### スプリント3（3-4週間）: セキュリティとパフォーマンス

**目標**: 本番環境で使用可能なレベルのセキュリティを実装

- [ ] APIキー認証
- [ ] レート制限
- [ ] 入力バリデーション
- [ ] メモリキャッシュ
- [ ] 権限ベースのアクセス制御
- [ ] サンドボックス実行
- [ ] 監査ログ
- [ ] ヘルスチェックAPI

**期待される成果**: Phase 3の完成、本番環境で使用可能

---

### スプリント4以降（オプショナル）: 高度な機能

**目標**: 拡張性と運用性の向上

- [ ] Phase 4: ツール管理の高度化
- [ ] Phase 5: 拡張機能

**期待される成果**: エンタープライズグレードの機能セット

---

## 💡 重要な技術的負債と設計ギャップ

### 1. HTTP APIの不在

**問題点**:
- 設計ドキュメント（`docs/design/01-core-features.md`）では、Fastifyベースの**HTTP API**が計画されていますが、現在の実装は**stdio専用のMCPサーバー**です。
- ドキュメントには`GET /tools`, `POST /tools/call`などのHTTPエンドポイントが設計されていますが、実装されていません。

**影響**:
- Phase 2（検索機能）とPhase 3（認証・レート制限）の多くの機能はHTTP APIを前提としています
- 現在のstdio実装では、これらの機能を追加するのが困難

**推奨アクション**:
1. **オプションA**: stdio実装を維持し、Phase 2以降の機能は実装しない（MCPアグリゲーターに特化）
2. **オプションB**: Fastify HTTP APIを追加実装し、stdioとHTTPの両方をサポート
3. **オプションC**: 設計ドキュメントをstdio専用に書き直す

---

### 2. ツールレジストリの二重化

**問題点**:
- `src/tool-registry.ts`が存在しますが、実際には使用されていません
- MCPClientManagerが直接ツールを管理しています
- 設計ドキュメントでは`ToolRegistry`が中心的な役割を果たす前提

**影響**:
- Phase 2（検索機能）とPhase 4（ツール管理）は`ToolRegistry`を前提に設計されています
- 現在のアーキテクチャでは、これらの機能を追加するのが困難

**推奨アクション**:
- MCPClientManagerとToolRegistryの統合、または明確な役割分担の定義

---

### 3. 型定義の分散

**問題点**:
- `src/types.ts`と`src/types/mcp.ts`が存在し、型定義が分散
- 設計ドキュメントの型定義（`docs/design/01-core-features.md:581-669`）と実装が不一致

**推奨アクション**:
- 型定義の統一と整理

---

## 📊 工数サマリー

| フェーズ | 最優先 | 中優先 | 低優先 | 合計 |
|---------|-------|-------|-------|------|
| Phase 1 | 6-9日 | 5-8日 | 1-2日 | 12-19日 |
| Phase 2 | 6-9日 | 4-7日 | 2-3日 | 12-19日 |
| Phase 3 | 10-14日 | 10-16日 | 3-4日 | 23-34日 |
| Phase 4 | 0日 | 5-7日 | 9-13日 | 14-20日 |
| Phase 5 | 0日 | 0日 | 26-36日 | 26-36日 |
| **合計** | **22-32日** | **24-38日** | **41-58日** | **87-128日** |

**現実的な最小限の実装**（最優先 + 中優先の一部）: 約**40-50日**

---

## 🎯 推奨事項

### 短期（1-2ヶ月）

1. **Phase 1を完成させる**
   - エラーハンドリング強化
   - 自動再接続機能
   - CLIコマンド

2. **Phase 2の基本検索機能を実装**
   - テキスト検索
   - 複合検索API

3. **Phase 3の必須セキュリティ機能を実装**
   - APIキー認証
   - レート制限
   - 入力バリデーション

### 中期（3-6ヶ月）

4. **Phase 3のパフォーマンス機能を実装**
   - メモリキャッシュ
   - 並列実行
   - ヘルスチェック

5. **Phase 2の高度な検索機能を実装**
   - タグ・カテゴリフィルタリング
   - 検索最適化

### 長期（6ヶ月以上）

6. **Phase 4とPhase 5の機能を検討**
   - ユーザーからのフィードバックに基づいて優先順位を調整

---

## 🔍 アーキテクチャレビューの必要性

現在の実装とドキュメントの間に大きなギャップがあります。以下の点について、プロジェクトの方向性を明確にする必要があります：

1. **HTTPベースAPI vs stdio専用**
   - どちらの方向性で進めるか決定が必要

2. **ToolRegistryの役割**
   - MCPClientManagerとの関係を明確化

3. **設計ドキュメントの更新**
   - 現在の実装に合わせてドキュメントを更新するか
   - ドキュメント通りに実装を進めるか

---

## 📝 結論

Search MCP Serverは**基本的なMCPアグリゲーター機能**は実装されていますが、設計ドキュメントで計画されている機能の**約75%が未実装**です。

**最も重要な次のステップ**:
1. Phase 1の完成（エラーハンドリング、再接続、CLI）
2. 検索機能の実装（プロジェクトの主要価値提案）
3. 基本的なセキュリティ機能の実装（本番環境対応）

これらを実装することで、Search MCPは真に価値のある製品になります。
